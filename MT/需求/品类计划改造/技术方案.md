
## 品类计划配置

**数据库结构**




**城市阈值配置**

> 查询城市阈值配置

```plantuml
@startuml
actor user
participant mds
participant db
user -> mds:发起查询请求
mds -> db:查询category_plan_conf表, conf_type = 1, conf_dimension = 1
mds -> user:返回列表
@enduml
```

> 新增城市阈值配置

```plantuml
@startuml

actor user
participant mds
participant db
participant squirrel
participant metrics

user -> mds : 新增城市阈值配置
mds -> squirrel : 加锁

mds -> db : 查询是否存在该城市维度的阈值配置
alt 不存在配置冲突
	mds -> mds : 构建category_plan_conf对象
	mds -> db : 保存db
	mds -> metrics : 上报日志
else 存在配置冲突
	mds -> user : 提示保存失败
end
mds -> squirrel: finally执行释放锁
@enduml
```

> 调整城市阈值配置

```plantuml
@startuml

actor user
participant mds
participant db
participant squirrel
participant metrics

user -> mds: 调整城市阈值
mds -> db: 查询该城市阈值
mds -> mds: 城市阈值比对检查
alt 城市调整偏差超过城市总量预警上、下偏差
	mds --> 大象: 大象提醒
end
mds -> db: 修改城市阈值配置
mds -> metrics: 上报修改日志
@enduml
```


**城市+品类阈值配置**

> 查询城市+品类阈值配置

```plantuml

@startuml
actor user
participant mds
participant db
user -> mds:发起查询请求
mds -> db:查询category_plan_conf表, conf_type = 1, conf_dimension = 2/3
mds -> user:返回列表
@enduml

```
> 导入城市+品类阈值配置

```plantuml
@startuml

actor user
participant mds
participant db
participant squirrel
participant metrics

user -> mds : 上传城市阈值配置
mds -> squirrel : 加导入锁

mds -> mds: 1、校验excel文件 2、校验品类 3、校验城市 4、校验业务分组
alt 校验通过
mds -> db: 根据城市ID+业务分组+品类ID查询配置
mds -> mds: 组装数据库对象
mds -> db: 更新或插入
mds -> metrics: 上报日志
mds -> 大象: 发送成功通知
else 校验失败
mds -> 大象: 发送失败通知并返回错误Excel
end
mds -> squirrel: finally执行释放锁
@enduml
```

**销售-订货口径转换系数配置**

> 查询销售-订货口径转换系数
```plantuml
@startuml
actor user
participant mds
participant db
user -> mds:发起查询请求
mds -> db:查询category_plan_conf表, conf_type = 2, conf_dimension = 3
mds -> rpc: 查询历史四周的销售转换系数
mds -> mds: 组装对象
mds -> user:返回列表
@enduml
```

> 导入销售-订货口径转换系数

```plantuml
@startuml

actor user
participant mds
participant db
participant squirrel
participant metrics

user -> mds : 上传转换系数配置
mds -> squirrel : 加导入锁

mds -> mds: 1、校验excel文件 2、校验品类 3、校验城市 4、校验业务分组
alt 校验通过
mds -> db: 根据城市ID+业务分组+品类ID查询配置
mds -> mds: 组装数据库对象
mds -> db: 更新或插入
mds -> metrics: 上报日志
mds -> 大象: 发送成功通知
else 校验失败
mds -> 大象: 发送失败通知并返回错误Excel
end
mds -> squirrel: finally执行释放锁
@enduml
```

**计划调整维度管理**

> 查询

```plantuml
@startuml
actor user
participant mds
participant db
user -> mds:发起查询请求
mds -> db:查询category_plan_adjust_conf表
mds -> mds: 计算每周的起止日期
mds -> user:返回列表
@enduml
```

> 导入

```plantuml
@startuml

actor user
participant mds
participant db
participant squirrel
participant metrics

user -> mds : 上传调整方式配置
mds -> squirrel : 加导入锁

mds -> mds: 1、校验excel文件 2、校验城市 3、校验业务分组
alt 校验通过
mds -> db: 根据城市ID+业务分组查询配置
mds -> mds: 组装数据库对象
mds -> db: 更新或插入
mds -> metrics: 上报日志
mds -> 大象: 发送成功通知
else 校验失败
mds -> 大象: 发送失败通知并返回错误Excel
end
mds -> squirrel: finally执行释放锁
@enduml
```

> 批量新增

```plantuml
@startuml

actor user
participant mds
participant db
participant squirrel
participant metrics

user -> mds : 新增计划调整方式
mds -> squirrel : 加锁

mds -> db : 查询是否存在该城市维度+业务分组的调整方式配置
alt 不存在配置冲突
	mds -> mds : 构建category_plan_adjust_conf对象
	mds -> db : 保存db
	mds -> metrics : 上报日志
else 存在配置冲突
	mds -> user : 提示保存失败
end
mds -> squirrel: finally执行释放锁
@enduml
```



## 品类计划看板

> 查询品类计划看板

```plantuml
@startuml
actor user
participant mds
participant db

user -> mds: 查询品类计划看板
activate mds
mds -> db: 1.查询category_plan_version每天最后的一个版本
mds -> db: 2.根据版本号查询category_plan_snapshot获取计划销量与比例
mds -> db: 3.根据城市+业务分组+dt查询实际销量与占比
mds -> mds: 计算城市+业务+dt的销量及销量占比的准确率
return 返回列表

@enduml
```

> 导出品类计划看板

```plantuml
@startuml
actor user
participant mds
participant db

user -> mds: 查询品类计划看板
activate mds
mds -> db: 1.查询category_plan_version每天最后的一个版本
mds -> db: 2.根据版本号查询category_plan_snapshot获取计划销量与比例
mds -> db: 3.根据城市+业务分组+dt查询实际销量与占比
mds -> mds: 计算城市+业务+dt的销量及销量占比的准确率
mds -> mds: 构建excel文件
return 返回导出文件

@enduml

```


## 品类计划管理

**计划调整审核**

dt销量锁定与修改不冲突，锁定只是为了不受一件凑整的影响

> 批量确认

```plantuml
@startuml

actor user
participant mds
participant db

user -> mds: 发起批量审核请求
activate mds
mds -> db: 根据ID查询审核表获取城市+业务分组+三级品类+dt的待审核销量
mds -> db: 根据城市+业务分组+三级品类批量查询草稿表获取销量
mds -> mds: 根据dt将待审核的销量进行修改
mds -> db: 根据草稿ID保存草稿表
mds -> db: 将审核表记录修改为已审核
return 审核成功
@enduml
```

> 批量驳回

```plantuml
@startuml

actor user
participant mds
participant db

user -> mds: 发起批量驳回请求
activate mds
mds -> db: 根据ID批量更新审核表为驳回状态
return 驳回成功



@enduml
```

**RDC盖帽/撤回**

> 盖帽

```plantuml
@startuml

actor user

user -> mds: 发起rdc盖帽标记请求
activate mds
mds -> db: 新增城市+业务分组+品类的盖帽标记
return 应用成功
@enduml
```

> 撤回

```plantuml
@startuml

actor user

user -> mds: 发起rdc盖帽撤销标记请求
activate mds
mds -> db: 删除城市+业务分组+品类的盖帽标记
return 撤回
@enduml
```


## 页面查询

**二级品类页查询**

```plantuml
@startuml
actor user

user -> mds: 查询二级品类计划
activate mds
mds -> db: 查询草稿表获取最新计划
alt 若选择对比版本
mds -> db: 查询快照表或去对应版本数据
end
alt 若选择计划时段
mds -> db: 查询历史的补全销量及比例
end
mds -> mds: 拆分日期到为周维度+日维度
alt 若选择sku预测聚合/品类预测聚合
mds -> foreast: 调用接口查询预测聚合数据
end
mds -> mds: 组装返回数据
return 返回二级品类列表
@enduml
```

**三级品类页查询**

```plantuml
@startuml
actor user

user -> mds: 发送查询三级品类计划请求
activate mds
mds -> db: 根据选择计划查询草稿表最新版本的二级品类
mds -> db: 根据城市+业务分组+二级品类查询三级品类草稿
mds -> mds: 拆分日期到为周维度+日维度
mds -> mds: 组装返回列表
return 返回三级品类列表
@enduml
```

**二级品类导出**

```plantuml
@startuml
actor user

user -> mds: 发送导出品类计划请求
activate mds
mds -> db: 根据城市+业务分组查询二级品类计划
mds -> mds: 拆分日期到日维度+周维度
alt 若选择sku预测聚合/品类预测聚合
mds -> foreast: 调用接口查询预测聚合数据
end
mds -> mds: 组装导出文件
mds -> 大象: 上传文件并发送通知
deactivate


@enduml
```


**三级品类导出**

```plantuml
@startuml
actor user

user -> mds: 发送导出品类计划请求
activate mds
mds -> db: 根据城市+业务分组查询三级品类计划
mds -> mds: 拆分日期到日维度+周维度
alt 若选择sku预测聚合/品类预测聚合
mds -> foreast: 调用接口查询预测聚合数据
end
mds -> mds: 组装导出文件
mds -> 大象: 上传文件并发送通知
deactivate


@enduml
```








**审核页查询**

```plantuml
@startuml

actor user

user -> mds: 发起查询审核信息请求
activate mds
mds -> lion: 获取当前人有权限的经营城市
mds -> db: 根据经营城市查询category_plan_audit
mds -> mds: 组装返回对象
return 返回列表
@enduml
```

