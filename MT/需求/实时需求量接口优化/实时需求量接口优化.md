[（待处理）20240122-实时需求量接口耗时优化问题](https://km.sankuai.com/collabpage/2087207018)

核心链路方法：`FdcDemandRTService.queryDemandPlan()`​

## 算法推荐兜底库存接口

入口：`FdcDemandRTCommonService.querySku2FallBackStockConfigMapFuture()`​ 异步调用以下代码

```java
    /**
     * 异步查询兜底库存配置
     *
     * @param poiId
     * @param skuIds
     * @param skuIdDemandPlanDaysMap
     * @return
     */
    public CompletableFuture<Map<Long, FallBackStockConfigDTO>> querySku2FallBackStockConfigMapFuture(long poiId,
                                                                                                      List<Long> skuIds, Map<Long, List<DemandPlanDaysRTDTO>> skuIdDemandPlanDaysMap) {
        return CompletableFuture.supplyAsync(() -> {
            try {
                return fdcFallbackStockRTService.querySku2FallBackStockConfigMap(poiId, skuIds, skuIdDemandPlanDaysMap);
            } catch (GatewayException e) {
                log.error(e.getMessage(), e);
                throw new RuntimeException(e);
            }
        }, executorService);
    }
```

​![image](assets/image-20240417142916-6qpwl37.png)​

优化点：

```java
    private Map<Long, SafetyStockResultDTO> getSafeStock(long poiId, Map<Long, String> quantileMap,
                                                        Map<Long, Integer> sku2SpecialSceneLabelMap,
                                                        ForecastServiceTypeEnum type,
                                                        Map<Long, List<Pair<String, String>>> sku2ReceiveDatePairListMap) {
        List<SafetyStockSkuParam> paramList = buildParamList(quantileMap, sku2SpecialSceneLabelMap, sku2ReceiveDatePairListMap);
        // 分页查询
        List<List<SafetyStockSkuParam>> lists = Lists.partition(paramList, CommonTool.GROUP_NUM_100);
        List<SafetyStockResult> safetyStockResultList = Lists.newArrayList();
        for (List<SafetyStockSkuParam> list : lists) {
            SafetyStockParam safetyStockParam = buildRequest(poiId, list, type);
            try {
                safetyStockResultList.add(getSafeStock(safetyStockParam));
            } catch (TException e) {
                logger.error("forecastApiV2TService.SafetyStockInfos error, request={}", safetyStockParam);
                throw new RpcCallException("getSafeStock error", e);
            }
        }
        return parseResult(safetyStockResultList);
    }
```

## 算法推荐安全库存接口

入口：`FdcDemandRTCommonService.querySku2CapPoiSkuConfigMapFuture()`​ 异步调用以下代码

```java
    /**
     * 异步查询安全库存配置
     *
     * @param poiDTO
     * @param skuPack
     * @param highPrioritySkuDTO
     * @return
     */
    public CompletableFuture<Map<Long, CapPoiSkuConfigDTO>> querySku2CapPoiSkuConfigMapFuture(PoiDTO poiDTO,
                                                                                              FdcDemandPlanSkuPack skuPack,
                                                                                              PoiIdsAndSkuIdsDTO highPrioritySkuDTO,
                                                                                              Map<Long, PoiSkuDateOfflineData> sku2OfflineDataMap,
                                                                                              Map<Long, List<DemandPlanDaysRTDTO>> sku2DemandPlanDaysListMap) {
        return CompletableFuture.supplyAsync(() -> {
            try {
                Map<Long, CapPoiSkuConfigDTO> sku2CapPoiSkuConfigMap = safeStockRTService.querySku2CapPoiSkuConfigMap(poiDTO, skuPack, highPrioritySkuDTO, sku2DemandPlanDaysListMap);
                return safeStockRTService.replaceStdev(sku2CapPoiSkuConfigMap, sku2OfflineDataMap);
            } catch (GatewayException e) {
                log.error(e.getMessage(), e);
                throw new RuntimeException(e);
            }
        }, executorService);
    }
```

​![image](assets/image-20240417145739-q9amz6f.png)​

优化点

```java
    private Map<Long, SafetyStockResultDTO> getSafeStock(long poiId, Map<Long, String> quantileMap,
                                                        Map<Long, Integer> sku2SpecialSceneLabelMap,
                                                        ForecastServiceTypeEnum type,
                                                        Map<Long, List<Pair<String, String>>> sku2ReceiveDatePairListMap) {
        List<SafetyStockSkuParam> paramList = buildParamList(quantileMap, sku2SpecialSceneLabelMap, sku2ReceiveDatePairListMap);
        // 分页查询
        List<List<SafetyStockSkuParam>> lists = Lists.partition(paramList, CommonTool.GROUP_NUM_100);
        List<SafetyStockResult> safetyStockResultList = Lists.newArrayList();
        for (List<SafetyStockSkuParam> list : lists) {
            SafetyStockParam safetyStockParam = buildRequest(poiId, list, type);
            try {
                safetyStockResultList.add(getSafeStock(safetyStockParam));
            } catch (TException e) {
                logger.error("forecastApiV2TService.SafetyStockInfos error, request={}", safetyStockParam);
                throw new RpcCallException("getSafeStock error", e);
            }
        }
        return parseResult(safetyStockResultList);
    }
```

## 总结

两个接口的目前耗时主要集中于`com.sankuai.mall.mds.gateway.ForecastGateway getSafeStock()`​方法

上层为

```java
    public Map<Long, SafetyStockResultDTO> getSafeStockGray(long poiId,
                                                            Map<Long, String> quantileMap,
                                                            Map<Long, Integer> sku2SpecialSceneLabelMap,
                                                            ForecastServiceTypeEnum type,
                                                            Map<Long, List<Pair<String, String>>> sku2ReceiveDatePairListMap,
                                                            Map<Long, List<AiSafeStockParamDTO>> skuId2AiParamListMap) {

        AiStockInfoQueryContext queryContext = AiStockInfoQueryContext.builder()
                .poiId(poiId)
                .quantileMap(quantileMap)
                .sku2SpecialSceneLabelMap(sku2SpecialSceneLabelMap)
                .type(type)
                .skuId2AiParamListMap(skuId2AiParamListMap)
                .build();

        if (aiSafeStockGrayConfigWrapper.shouldCompare(poiId)) {
            Cat.logBatchEvent("compareSafeStock", String.valueOf(poiId), 1, 0);
            asyncCompareSafeStock(poiId, quantileMap, sku2SpecialSceneLabelMap, type, sku2ReceiveDatePairListMap, queryContext);
        }

		// 主要依靠两个分支
        if (aiSafeStockGrayConfigWrapper.isUseNewSwitch()) {
            Cat.logBatchEvent("newSafeStock", String.valueOf(poiId), 1, 0);
			// 主要更改新逻辑
            return getSafeStock(queryContext);
        }

        Cat.logBatchEvent("oldSafeStock", String.valueOf(poiId), 1, 0);
        return getSafeStock(poiId, quantileMap, sku2SpecialSceneLabelMap, type, sku2ReceiveDatePairListMap);
    }
```

## 方案

```java
    private List<SafetyStockResult> parallelGetSafeStock(List<List<SafetyStockSkuParam>> paramPart,
                                                         long poiId,
                                                         ForecastServiceTypeEnum type) {
        List<CompletableFuture<SafetyStockResult>> futures =
                paramPart.stream().map(part -> CompletableFuture.supplyAsync(() -> {
            SafetyStockParam safetyStockParam = buildRequest(poiId, part, type);
            try {
                return getSafeStock(safetyStockParam);
            } catch (TException e) {
                logger.error("forecastApiV2TService.SafetyStockInfos error, request={}", safetyStockParam);
                throw new RpcCallException("getSafeStock error", e);
            }
        }, FORECAST_GET_STOCK_POOL)).collect(Collectors.toList());

        return futures.stream().map(CompletableFuture::join)
                .filter(Objects::nonNull)
                .collect(Collectors.toList());
    }

    private static final ExecutorService FORECAST_GET_STOCK_POOL = ExecutorServices.forThreadPoolExecutor(
            "forecastGetStockPool", 1, TimeUnit.MINUTES, new ThreadPoolExecutor.CallerRunsPolicy()
    );
```
